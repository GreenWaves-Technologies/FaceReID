# Build
## Environment Setup

The demo requires extra packages for testing:

```
    $ sudo apt-get install python3 python3-pip python3-setuptools python3-tk python3-dev imagemagick
    $ sudo pip3 install opencv_python
```

## Build and Run Demo for Gapuino and Gapoc A

```
    $ source [GAP_SDK Directory]/configs/[board_name].sh
    $ cd ReID-Demo
    $ make all run
```

# Static Faces Database

The Demo implementation can use pre-generated static descriptors for known users. The feature can be enabled by passing `STATIC_DB=1` to `make` command.

## Known Faces Database from Images

It is possible to generate a database of known users with any photos made with any camera you have. The only restriction â€“ one person per image. To generate the database do the following:

1. Put all face images to one folder. It's expected that each photo contains only one face and file is named by a person name.
2. Connect Gapuino or Gapoc A board to desktop and prepare SDK environment.
```
    $ source [GAP_SDK Directory]/configs/[board_name].sh
```
3. Run `generate_known_faces_db_device.sh` script with faces folder as parameter:
```
    $ ../scripts/generate_known_faces_db_device.sh [face gallery path]
```
The script crops faces from all photos and puts them with calculated descriptors to `ReID-Demo/known_faces` folder.

# Known Faces Database from Descriptors

The users database can be compiled manually using the demo itself.

1. Build and run demo with `DUMP_SUCCESSFUL_FRAME=1` option like this:
```
    $ make DUMP_SUCCESSFUL_FRAME=1 all run
```
2. Place all users in front of the camera and achieve several successful detections of each person.
3. Stop the application and review `ReID-Demo/dumps` folder. The folder contains face previews generated by face detector and their corresponding descriptors. Pick good previews for all users, one for each person. Good detection is a preview with minimal amount of noise and background, that is sharp, contrast and contains face in frontal orientation.
4. Copy corresponding descriptor files (`face_xxx.bin`) to `ReID-Demo/known_faces` folder and rename in by template `person_x.bin`, where `x` is a number from zero to amount of users minus one. Corresponding face previews can be copied too, but they are ignored by scripts.
5. Modify `ReID-Demo/known_faces/index.txt` sample file and write names of all users in the same order as descriptor files, with new line each one. Please do not insert extra empty lines to the file.

# Important Options for Makefile and setup.h

The demo supports several configurations that are handled by macros in `setup.h` and `Makefile` variables that can be set in make command line or by editing file.

Makefile:
- `GRAPH`. Build ReID network inference code from a Autotiler graph model. The Demo should work the same way with either handcrafted or auto-generated inference code, but performance may slightly differ. The implementations have the same conract and selected on Makefile level, see `network_process_graph.c` and `network_process_manual.c`.
- `STATIC_FACE_DB`. The flag bakes in pre-generated descriptors for known users and disabled user management on-the-go. The descriptors should be generated before the build. See "Generate Known Faces Database" chapter for details.
- `BLE_NOTIFIER`. The option is applicable for GAPoc A board and can be used together with `STATIC_FACE_DB=1` option only. When the feature is turned on GAPoc A board waits for a BLE connection from the Android application on start and sends information about all identified people over Bluetooth.
- `SILENT`. The flag disables `printf` calls in the demo code to run demo without USB bridge connection.
- `DUMP_SUCCESSFUL_FRAME`. The option enables face photo and descriptor dumping to host for each successful detector call. The descriptors can be used together with `STATIC_FACE_DB=1` option.
- `BLE_NAME`. Can be used to set a Bluetooth adapter name. Gapoc A is using `GreenWaves-GAPOC` as the Bluetooth name by default.

setup.h:
- `REID_L2_THRESHOLD`. L2 metric threshold for users identification. Person in front of the camera is treated as a stranger if minimal L2 metric in correspondence with all known users is above the value.
- `STRANGER_L2_THRESHOLD`  L2 metric threshold for strangers de-duplication in case of delayed users management. Person in front of the camera is treated as an unknown stranger if minimal L2 metric in correspondence with all saved strangers is above the value.
- `FACE_DB_SIZE`. Maximum amount of known users that can be handled by the demo. The option is overridden, if `STATIC_FACE_DB=1` is set during the demo build. See section "Prepare Known Faces Database Manually" for more details.
- `STRANGERS_DB_SIZE`. Maximum amount of strangers handled by demo.

# Tests

0. Download and put activations dump to `tests/activations_dump` folder by [link](https://face-reid-artifacts.s3.eu-west-3.amazonaws.com/FaceID/activations_dump.tar.bz2) or use activations dump for self-trained network.

1. Run per-layer test:
```
    $ source [GAP_SDK Directory]/configs/[board_name].sh
    $ cd tests
    $ ./test_layers_one_by_one.sh
```

2. Run full network inference test:
```
    $ source [GAP_SDK Directory]/configs/[board_name].sh
    $ cd tests
    $ ./test_inference.sh
```

3. Run inference preparation steps test:
```
    $ source [GAP_SDK Directory]/configs/[board_name].sh
    $ cd tests
    $ ./test_prepare_pipeline.sh [board type: -gapoc or -gapuino]
```

4. Run full re-id pipeline test:
```
    $ source [GAP_SDK Directory]/sourceme.sh # Select MCU generation GAP8 (1)
    $ cd tests/reid_pipeline_test
    $ make BOARD_NAME=gapuino all run # for Gapuino board
    $ make BOARD_NAME=gapoc_a all run # for Gapoc A board
```
Test application output should contain line `Hi, Lena! Conf: 150` where confidence can vary depending on model quantization, but should not be too big.
