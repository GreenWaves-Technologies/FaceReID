# Build
## Environment Setup

The demo requires extra packages for build and testing:

```
    $ sudo apt-get install python3 python3-pip python3-setuptools python3-tk python3-dev imagemagick
    $ sudo pip3 install opencv_python
```

## Build and Run Demo for Gapuino

```
    $ source [GAP_SDK Directory]/sourceme.sh # Select MCU generation GAP8 (1)
    $ cd ReID-Demo
    $ make BOARD_NAME=gapuino run
```

## Build and Run Demo for Gapoc A

```
    $ source [GAP_SDK Directory]/sourceme.sh  # Select MCU generation GAP8 (1)
    $ cd ReID-Demo
    $ make BOARD_NAME=gapoc_a run
```

# Static Faces Database

The Demo implementation can use pre-generated static descriptors for known users only. The option is managed by `STATIC_DB=1` flag in the demo makefile.

## Known Faces Database from Images

There is option to generate database of known users with any photos made with any camera you have. The only restriction - one person per image. To generate database do the following:

1. Put all face images to one folder. It's expected that each photo contains only one face and file is named by person name.
2. Connect Gapuino or Gapoc A board to desktop and prepare SDK environment.
```
    $ source [GAP_SDK Directory]/sourceme.sh # Select MCU generation GAP8 (1)
```
3. Run `generate_known_faces_db_device.sh` script with faces folder as parameter:
```
    $ ../scripts/generate_known_faces_db_device.sh [board type: -gapoc or -gapuino] [test galery path]
```
The script crops faces from all photos and put them with calculated descriptors to `ReID-Demo/known_faces` folder.

# Known Faces Database from Descriptors

The users database can be compiled manually using the demo itself.

1. Build and run demo with `DUMP_SUCCESSFUL_FRAME=1` option like this:
```
    $ make BOARD_NAME=gapoc_a DUMP_SUCCESSFUL_FRAME=1 run
```
2. Place all users in front of the camera and achieve several successfully detections for each.
3. Stop the application and review `ReID-Demo/dumps` folder. The folder contains face previews generated by face detector and corresponding descriptor. Please select good previews for all users, one for each person. Good detection is preview with minimal amount of noise, background, that is sharp, contrast and contains face in frontal orientation.
4. Copy corresponding descriptor files (`embedding_xxx.bin`) to `ReID-Demo/known_faces` folder and rename in by template `person_x.bin`, where `x` - is number from zero to amount of users minus one. Corresponding face previews can be copied too, but they are ignored by scripts.
5. Create `ReID-Demo/known_faces/index.txt` file and write names of all users in the same order ans descriptor files, with new line each one. Please do not insert extra empty lines to the file. Look into `tests/db_selector_test/known_faces` for reference.

# Important Options for Makefile and setup.h

The demo supports several configurations that are handled by macro in `setup.h` and `Makefile` variables that can be set in make command line or by editing file.

Makefile:
- `BOARD_NAME`. The option defines board name for PMSIS BSP and manages the demo capabilities. The demo build with `BOARD_NAME=gapoc_a` enables BLE stack, delayed strangers management and strangers de-duplication step. `BOARD_NAME=gapuino` enables PS/2 keyboard driver instead of the BLE solution.
- `DEVICE_CONNECTION`. The option determines board connection type (direct USB connection or over OLIMEX JTAG adapter). Is set automatically, depending on board name.
- `STATIC_FACE_DB`. The flag bakes in pre-generated descriptors for known users and disabled user management on-the-go. The descriptors should be generated before the build. See "Generate Known Faces Database" chapter for details.
- `BLE_NOTIFIER`. The option applicable for GAPoc A board and can be used together with `STATIC_FACE_DB=1` option only. With the feature is turned on GAPoc A board waits for Android app connection with Bluetooth LE on start and sends information about all identified people over Bluetooth.
- `SILENT`. The flag disables `printf` calls in the demo code to run demo without USB bridge connection.
- `DUMP_SUCCESSFUL_FRAME`. The option enabled face photo and descriptor dumping to host for each successful detector call. The descriptors can be used together with `STATIC_FACE_DB=1` option. See

setup.h:
- `REID_L2_THRESHOLD`. L2 metric threshold for users identification. Person in front of the camera is trietted as stranger if minimal L2 metric in correspondence with all known users is above the value.
- `STRANGER_L2_THRESHOLD`  L2 metric threshold for strangers de-duplication in case of delayed users management. Person in front of the camera is stritted as not known stranger if minimal L2 metric in correspondence with all saved strangers is above the value.
- `FACE_DB_SIZE`. Maximum amount of known users can be handled by demo. The option is overridden, if `STATIC_FACE_DB=1` is set during the demo build. See section "Prepare Known Faces Database Manually" for more details.
- `STRANGERS_DB_SIZE`. Maximum amount of strangers can be handled by demo.

# Tests

0. Download and put activations dump to `tests/activations_dump` folder by [link](https://drive.google.com/open?id=15NbUlI_5Uwxx3owOLZvs6mSGNp7WjDrH) or use activations dump for self-trained network.

1. Run per-layer test:
```
    $ source [GAP_SDK Directory]/sourceme.sh # Select MCU generation GAP8 (1)
    $ cd tests
    $ ./test_layers_one_by_one.sh [board type: -gapoc or -gapuino]
```

2. Run full network inference test:
```
    $ source [GAP_SDK Directory]/sourceme.sh # Select MCU generation GAP8 (1)
    $ cd tests
    $ ./test_inference.sh [board type: -gapoc or -gapuino]
```

3. Run inference preparation steps test:
```
    $ source [GAP_SDK Directory]/sourceme.sh # Select MCU generation GAP8 (1)
    $ cd tests
    $ ./test_prepare_pipeline.sh [board type: -gapoc or -gapuino]
```

4. Run full re-id pipeline test:
```
    $ source [GAP_SDK Directory]/sourceme.sh # Select MCU generation GAP8 (1)
    $ cd tests/reid_pipeline_test
    $ make BOARD_NAME=gapuino DEVICE_CONNECTION=-jtag run # for Gapuino board
    $ make BOARD_NAME=gapoc_a DEVICE_CONNECTION=-ftdi run # for Gapoc A board
```
Test application output should contain line `Hi, Lena! Conf: 150` where confidence can vary depending on SDK (Autotiler) version, but should not be too big.
